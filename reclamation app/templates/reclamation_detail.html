{% extends "base.html" %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <div class="pill mb-2">Detail</div>
      <h1 class="h4 mb-0">Reclamation {{ reclamation["numero_dossier"] }}</h1>
      <p class="text-muted mb-0">Statut: {{ reclamation["statut"] }}</p>
    </div>
    <a class="btn btn-outline-secondary" href="/dashboard">Retour</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Client:</strong> {{ reclamation["nom_client"] }}</p>
          <p><strong>Compte:</strong> {{ reclamation["numero_compte"] }}</p>
          <p><strong>Type:</strong> {{ reclamation["libelle"] or "-" }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Bureau:</strong> {{ reclamation["nom_bureau"] or "-" }}</p>
          <p><strong>Soumis par:</strong> {{ reclamation["username"] or "-" }}</p>
          <p><strong>Date:</strong> {{ reclamation["created_at"] }}</p>
          {% if reclamation["statut"] != "TRAITEE" and current_user.role == "agent" %}
            <p class="d-flex align-items-center gap-2">
              <strong>Action:</strong>
              <form method="post" action="/reclamation/{{ reclamation['id'] }}/reminder" class="mb-0">
                <button class="btn btn-warning btn-sm" type="submit" {% if reminder_disabled %}disabled{% endif %}>
                  Rappel
                </button>
              </form>
            </p>
            {% if reminder_disabled and reminder_remaining_min %}
              <div class="text-muted small">Rappel disponible dans {{ reminder_remaining_min }} min.</div>
            {% endif %}
          {% endif %}
        </div>
      </div>
      <p><strong>Ancienne info:</strong> {{ reclamation["ancienne_valeur"] or "-" }}</p>
      <p><strong>Nouvelle info:</strong> {{ reclamation["nouvelle_valeur"] or "-" }}</p>
      <p><strong>Motif:</strong> {{ reclamation["motif"] }}</p>
      {% if reclamation["observation"] %}
        <p><strong>Observation:</strong> {{ reclamation["observation"] }}</p>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6">Pieces jointes</h2>
      {% if pieces %}
        <ul>
          {% for p in pieces %}
            <li>
              <a href="/uploads/{{ p['filename'] }}">{{ p["original_name"] }}</a>
              <small class="text-muted">({{ p["uploaded_at"] }})</small>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">Aucune piece.</p>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6">Historique des statuts</h2>
      {% if historique %}
        <ul>
          {% for h in historique %}
            <li>
              {{ h["created_at"] }} - {{ h["nouveau_statut"] }}
              {% if h["observation"] %} - {{ h["observation"] }}{% endif %}
              {% if h["username"] %} ({{ h["username"] }}){% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">Aucun historique.</p>
      {% endif %}
    </div>
  </div>

  {% if current_user.role in ["supervisor", "admin"] %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6">Changer le statut</h2>
        <form method="post" action="/reclamation/{{ reclamation['id'] }}/status">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Nouveau statut</label>
              <select class="form-select" name="statut">
                <option value="EN_ATTENTE">EN_ATTENTE</option>
                <option value="EN_COURS">EN_COURS</option>
                <option value="TRAITEE">TRAITEE</option>
                <option value="REJETEE">REJETEE</option>
              </select>
            </div>
            <div class="col-md-8 mb-3">
              <label class="form-label">Observation</label>
              <input class="form-control" name="observation" />
            </div>
          </div>
          <button class="btn btn-primary" type="submit">Mettre a jour</button>
        </form>
        {% if reclamation["statut"] == "TRAITEE" %}
          <form method="post" action="/reclamation/{{ reclamation['id'] }}/archive" class="mt-3">
            <button class="btn btn-outline-secondary" type="submit">Archiver</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}
    <script></script>